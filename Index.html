<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light">
  <title>ç°¡æ˜“æ—¥æ›†ç­†è¨˜ v10.0ï¼ˆç­†è¨˜åŠŸèƒ½æ•´åˆç‰ˆï¼‰</title>
  <style>
  :root{
    --bg:#ffffff; --fg:#111111; --muted:#6b7280;
    --primary:#2563eb; --danger:#dc2626; --border:#e5e7eb;
    --selected:#f1f5f9; --surface:#f9fafb;
    --amount:#3b82f6; /* è—è‰²æ”¶æ”¯é»/æ·¨é¡é¡è‰² */
  }
  *{box-sizing:border-box}
  html,body{height:100%; -webkit-text-size-adjust:100%}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Heiti TC","Microsoft JhengHei",Arial,sans-serif;
    color:var(--fg); background:var(--bg);
  }
  .topbar{
    position:sticky; top:0; z-index:5;
    display:flex; align-items:center; gap:1rem;
    padding:.75rem 1rem; border-bottom:1px solid var(--border);
    background:rgba(255,255,255,.9); -webkit-backdrop-filter:blur(8px); backdrop-filter:blur(8px);
  }
  .topbar h1{margin:0; font-size:1.1rem}
  .spacer{flex:1}
  button{border:1px solid var(--border); background:#fff; padding:.45rem .7rem; border-radius:.5rem; cursor:pointer}
  button.ghost{background:transparent}
  main.stack{
    display:grid; grid-template-rows:1fr 1fr;
    gap:0;
    max-width:1000px; margin:0 auto; padding:1rem;
    min-height:calc(100vh - 120px);
  }
  #calendarPane, #notePane{display:flex; flex-direction:column; min-height:0; overflow:auto}
  .cal-header{display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:.5rem; margin:0;}
  #monthLabel{text-align:center; margin:.25rem 0; font-weight:700}
  .weekday-row, .grid{display:grid; grid-template-columns:repeat(7,1fr); gap:.25rem; margin:0;}
  .weekday-row div{ text-align:center; padding:.25rem 0; color:var(--muted); font-size:.9rem; font-weight:600}
  .grid{padding-bottom:0;}
  .grid .cell{
    border:1px solid var(--border); min-height:112px; border-radius:.5rem; padding:.5rem;
    display:flex; flex-direction:column; gap:.2rem; background:#fff; cursor:pointer; position:relative; color:var(--fg);
    transition:background-color .15s;
  }
  .grid .cell.selected{ background:var(--selected) }
  .grid .cell.today{ outline:2px solid var(--primary); outline-offset:1px }
  .grid .cell header{ display:flex; justify-content:space-between; align-items:flex-start; color:var(--fg) }
  .day-num{ font-weight:800; line-height:1; position:relative; padding-right:20px }
  .note-dot{ position:absolute; right:0; top:0; width:8px; height:8px; border-radius:50%; background:var(--danger); }
  .amount-dot{ 
    position:absolute; right:10px; top:0; width:8px; height:8px; border-radius:50%; background:var(--amount);
  }
  .preview{ margin-top:.1rem; font-size:.82rem; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .tools{ display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; padding:.25rem 0 .25rem 0; margin-top:.1cm }
  .tool-group{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap }
  #textNote{
    width:100%; margin-top:.3cm; min-height:22.5vh; resize:vertical;
    padding:.75rem; border:1px solid var(--border); border-radius:.5rem; font-size:1rem; line-height:1.6;
  }
  /* Popover */
  .popover{
    position:absolute; z-index:10; background:#fff; border:1px solid var(--border); border-radius:.6rem;
    box-shadow:0 8px 24px rgba(0,0,0,.08); padding:.6rem; width:min(560px, 94vw);
  }
  .row{ display:flex; gap:.4rem; align-items:center; margin:.35rem 0; flex-wrap:wrap }
  .muted{ color:var(--muted); font-size:.86rem }
  .chips{ display:flex; gap:.35rem; flex-wrap:wrap }
  .chip{ display:inline-flex; align-items:center; gap:.35rem; border:1px solid var(--border); background:var(--surface); border-radius:999px; padding:.2rem .55rem; font-size:.86rem }
  .chip button{ border:none; background:transparent; cursor:pointer; padding:0 .2rem }
  .sectionTitle{ font-weight:700; font-size:.9rem; color:#111; }
  @media print{
    body{ background:#fff }
    .topbar, #calendarPane, .popover{ display:none !important }
    #notePane{ padding:0; }
  }
  </style>
</head>
<body>
  <header class="topbar">
    <h1>ç°¡æ˜“æ—¥æ›†ç­†è¨˜ v10.0</h1>
    <div class="spacer"></div>
    <button id="installBtn" class="ghost" title="åŠ å…¥ä¸»ç•«é¢ï¼ˆå¯é¸ï¼‰">åŠ å…¥ä¸»ç•«é¢</button>
  </header>

  <main class="stack">
    <section id="calendarPane" aria-labelledby="monthLabel">
      <div class="cal-header">
        <button id="prevMonth" aria-label="å‰ä¸€å€‹æœˆ">â—€</button>
        <h2 id="monthLabel"></h2>
        <button id="nextMonth" aria-label="ä¸‹ä¸€å€‹æœˆ">â–¶</button>
      </div>
      <div class="weekday-row">
        <div>æ—¥</div><div>ä¸€</div><div>äºŒ</div><div>ä¸‰</div><div>å››</div><div>äº”</div><div>å…­</div>
      </div>
      <div id="grid" class="grid" role="grid" aria-label="æœˆæ›†"></div>
    </section>

    <section id="notePane">
      <div class="tools">
        <div class="tool-group">
          <button id="exportPdf" title="å°‡æœ¬æ—¥ç­†è¨˜åŒ¯å‡ºç‚º PDFï¼ˆä»¥åˆ—å°æ–¹å¼ï¼‰">ğŸ–¨ï¸ åŒ¯å‡º PDF</button>
          <button id="openPlan" title="æ‰¹æ¬¡åŠ å…¥å¤šæ—¥æœŸæ´»å‹•">æ¯é€±æ´»å‹•å®‰æ’</button>
          <button id="openReport" title="é¡¯ç¤ºæ¯é€±å’Œæ¯æœˆæ”¶æ”¯çµ±è¨ˆ">æ”¶æ”¯å ±è¡¨</button>
          <button id="openMyNotes" title="é–‹å•Ÿæˆ‘çš„ç­†è¨˜åŠŸèƒ½">ğŸ“ æˆ‘çš„ç­†è¨˜</button>
        </div>
      </div>

      <textarea id="textNote" aria-label="æ–‡å­—ç­†è¨˜"></textarea>
      <div id="accountingDetails" style="margin-top:1rem; padding:.75rem; border:1px solid var(--border); border-radius:.5rem; display:none"></div>
      <div id="planPop" class="popover" style="display:none"></div>
      <div id="reportPop" class="popover" style="display:none; width:min(700px, 98vw)"></div>
      <div id="myNotesPop" class="popover" style="display:none; width:min(800px, 98vw); max-height:90vh; overflow-y:auto"></div>
    </section>
  </main>

  <script>

    // ===== å”è©©äº”è¨€çµ•å¥è³‡æ–™åº« =====
    var tangPoems = [
      { title: 'éœå¤œæ€', author: 'æç™½', content: 'åºŠå‰æ˜æœˆå…‰ï¼Œç–‘æ˜¯åœ°ä¸Šéœœã€‚èˆ‰é ­æœ›æ˜æœˆï¼Œä½é ­æ€æ•…é„‰ã€‚' },
      { title: 'ç™»é¸›é›€æ¨“', author: 'ç‹ä¹‹æ¸™', content: 'ç™½æ—¥ä¾å±±ç›¡ï¼Œé»ƒæ²³å…¥æµ·æµã€‚æ¬²çª®åƒé‡Œç›®ï¼Œæ›´ä¸Šä¸€å±¤æ¨“ã€‚' },
      { title: 'æ˜¥æ›‰', author: 'å­Ÿæµ©ç„¶', content: 'æ˜¥çœ ä¸è¦ºæ›‰ï¼Œè™•è™•èå•¼é³¥ã€‚å¤œä¾†é¢¨é›¨è²ï¼ŒèŠ±è½çŸ¥å¤šå°‘ã€‚' },
      { title: 'é¹¿æŸ´', author: 'ç‹ç¶­', content: 'ç©ºå±±ä¸è¦‹äººï¼Œä½†èäººèªéŸ¿ã€‚è¿”æ™¯å…¥æ·±æ—ï¼Œå¾©ç…§é’è‹”ä¸Šã€‚' },
      { title: 'ç›¸æ€', author: 'ç‹ç¶­', content: 'ç´…è±†ç”Ÿå—åœ‹ï¼Œæ˜¥ä¾†ç™¼å¹¾æã€‚é¡˜å›å¤šæ¡æ“·ï¼Œæ­¤ç‰©æœ€ç›¸æ€ã€‚' },
      { title: 'é›œè©©', author: 'ç‹ç¶­', content: 'å›è‡ªæ•…é„‰ä¾†ï¼Œæ‡‰çŸ¥æ•…é„‰äº‹ã€‚ä¾†æ—¥ç¶ºçª—å‰ï¼Œå¯’æ¢…è‘—èŠ±æœªã€‚' },
      { title: 'é€åˆ¥', author: 'ç‹ç¶­', content: 'å±±ä¸­ç›¸é€ç½·ï¼Œæ—¥æš®æ©æŸ´æ‰‰ã€‚æ˜¥è‰æ˜å¹´ç¶ ï¼Œç‹å­«æ­¸ä¸æ­¸ã€‚' },
      { title: 'ç«¹é‡Œé¤¨', author: 'ç‹ç¶­', content: 'ç¨åå¹½ç¯è£¡ï¼Œå½ˆç´å¾©é•·å˜¯ã€‚æ·±æ—äººä¸çŸ¥ï¼Œæ˜æœˆä¾†ç›¸ç…§ã€‚' },
      { title: 'å®¿å»ºå¾·æ±Ÿ', author: 'å­Ÿæµ©ç„¶', content: 'ç§»èˆŸæ³Šç…™æ¸šï¼Œæ—¥æš®å®¢æ„æ–°ã€‚é‡æ› å¤©ä½æ¨¹ï¼Œæ±Ÿæ¸…æœˆè¿‘äººã€‚' },
      { title: 'æ˜¥æ€¨', author: 'é‡‘æ˜Œç·’', content: 'æ‰“èµ·é»ƒé¶¯å…’ï¼Œè«æ•™æä¸Šå•¼ã€‚å•¼æ™‚é©šå¦¾å¤¢ï¼Œä¸å¾—åˆ°é¼è¥¿ã€‚' },
      { title: 'æ±Ÿé›ª', author: 'æŸ³å®—å…ƒ', content: 'åƒå±±é³¥é£›çµ•ï¼Œè¬å¾‘äººè¹¤æ»…ã€‚å­¤èˆŸè“‘ç¬ ç¿ï¼Œç¨é‡£å¯’æ±Ÿé›ªã€‚' },
      { title: 'å°‹éš±è€…ä¸é‡', author: 'è³ˆå³¶', content: 'æ¾ä¸‹å•ç«¥å­ï¼Œè¨€å¸«æ¡è—¥å»ã€‚åªåœ¨æ­¤å±±ä¸­ï¼Œé›²æ·±ä¸çŸ¥è™•ã€‚' },
      { title: 'ç™»æ¨‚éŠåŸ', author: 'æå•†éš±', content: 'å‘æ™šæ„ä¸é©ï¼Œé©…è»Šç™»å¤åŸã€‚å¤•é™½ç„¡é™å¥½ï¼Œåªæ˜¯è¿‘é»ƒæ˜ã€‚' },
      { title: 'è½ç®', author: 'æç«¯', content: 'é³´ç®é‡‘ç²ŸæŸ±ï¼Œç´ æ‰‹ç‰æˆ¿å‰ã€‚æ¬²å¾—å‘¨éƒé¡§ï¼Œæ™‚æ™‚èª¤æ‹‚å¼¦ã€‚' },
      { title: 'æ–°å«å¨˜', author: 'ç‹å»º', content: 'ä¸‰æ—¥å…¥å»šä¸‹ï¼Œæ´—æ‰‹ä½œç¾¹æ¹¯ã€‚æœªè«³å§‘é£Ÿæ€§ï¼Œå…ˆé£å°å§‘å˜—ã€‚' },
      { title: 'æ±Ÿä¸Šæ¼è€…', author: 'èŒƒä»²æ·¹', content: 'æ±Ÿä¸Šå¾€ä¾†äººï¼Œä½†æ„›é±¸é­šç¾ã€‚å›çœ‹ä¸€è‘‰èˆŸï¼Œå‡ºæ²’é¢¨æ³¢è£¡ã€‚' },
      { title: 'å¤œå®¿å±±å¯º', author: 'æç™½', content: 'å±æ¨“é«˜ç™¾å°ºï¼Œæ‰‹å¯æ‘˜æ˜Ÿè¾°ã€‚ä¸æ•¢é«˜è²èªï¼Œæé©šå¤©ä¸Šäººã€‚' },
      { title: 'ç§‹å¤œå¯„é‚±å“¡å¤–', author: 'éŸ‹æ‡‰ç‰©', content: 'æ‡·å›å±¬ç§‹å¤œï¼Œæ•£æ­¥è© æ¶¼å¤©ã€‚ç©ºå±±æ¾å­è½ï¼Œå¹½äººæ‡‰æœªçœ ã€‚' },
      { title: 'å•åŠ‰åä¹', author: 'ç™½å±…æ˜“', content: 'ç¶ èŸ»æ–°é†…é…’ï¼Œç´…æ³¥å°ç«çˆã€‚æ™šä¾†å¤©æ¬²é›ªï¼Œèƒ½é£²ä¸€æ¯ç„¡ã€‚' },
      { title: 'å…«é™£åœ–', author: 'æœç”«', content: 'åŠŸè“‹ä¸‰åˆ†åœ‹ï¼Œåæˆå…«é™£åœ–ã€‚æ±ŸæµçŸ³ä¸è½‰ï¼Œéºæ¨å¤±åå³ã€‚' }
    ];

    // éš¨æ©Ÿé¸æ“‡ä¸€é¦–å”è©©
    function getRandomPoem() {
      var index = Math.floor(Math.random() * tangPoems.length);
      return tangPoems[index];
    }

    // æ’å…¥å”è©©åˆ°æ–‡å­—æ¬„ç¬¬ä¸€æ’
    function insertPoem() {
      var poem = getRandomPoem();
      var poemText = poem.content + ' â€”â€” ' + poem.author + 'ã€Š' + poem.title + 'ã€‹';
      var currentText = textNote.value;
      if (currentText) {
        textNote.value = poemText + '\n' + currentText;
      } else {
        textNote.value = poemText;
      }
      autoSave();
    }

  (function(){
    var grid = document.getElementById('grid');
    var monthLabel = document.getElementById('monthLabel');
    var prevMonth = document.getElementById('prevMonth');
    var nextMonth = document.getElementById('nextMonth');
    var textNote = document.getElementById('textNote');
    var installBtn = document.getElementById('installBtn');
    var exportBtn = document.getElementById('exportPdf');
    var openPlanBtn = document.getElementById('openPlan');
    var planPop = document.getElementById('planPop');
    var openReportBtn = document.getElementById('openReport');
    var reportPop = document.getElementById('reportPop');
    var accountingDetailsDiv = document.getElementById('accountingDetails');

    var state = { y:new Date().getFullYear(), m:new Date().getMonth(), currentISO:null, selectedCell:null };

    // ===== Helpers =====
    function pad2(n){ return String(n).padStart(2,'0'); }
    function isoOf(y,m,d){ return y + '-' + pad2(m+1) + '-' + pad2(d); }
    function isoFromDate(d){ return isoOf(d.getFullYear(), d.getMonth(), d.getDate()); }
    function loadNote(iso){ try { return JSON.parse(localStorage.getItem('note:' + iso) || 'null') || {text:''}; } catch(e){ return {text:''}; } }
    function saveNote(iso, obj){ localStorage.setItem('note:' + iso, JSON.stringify(obj)); }
    function setIndex(iso, hasContent){
      var idx = {}; try { idx = JSON.parse(localStorage.getItem('noteIndex')||'{}') || {}; } catch(e){ idx={}; }
      if (hasContent) idx[iso] = 1; else delete idx[iso];
      localStorage.setItem('noteIndex', JSON.stringify(idx));
    }
    
    function loadAmounts(iso){ try { return JSON.parse(localStorage.getItem('amounts:' + iso) || 'null') || {income:0, expense:0}; } catch(e){ return {income:0, expense:0}; } }

    function setAmountIndex(iso, hasContent){
      var idx = {}; try { idx = JSON.parse(localStorage.getItem('amountIndex')||'{}') || {}; } catch(e){ idx={}; }
      if (hasContent) idx[iso] = 1; else delete idx[iso];
      localStorage.setItem('amountIndex', JSON.stringify(idx));
    }
    
    // å¾æ–‡æœ¬ä¸­è§£ææ”¶æ”¯é‡‘é¡
    function parseAmounts(text){
      var lines = text.split(/\r?\n/).map(function(x){ return x.trim(); }).filter(Boolean);
      var income = 0, expense = 0;
      var normText;

      for (var i=0;i<lines.length;i++){
        normText = normalizeFW(lines[i]);
        
        // 1. åŒ¹é…æ”¶å…¥é—œéµå­—: ã€Œä¸­çã€ã€ã€Œçé‡‘ã€ã€ã€Œæ”¶å…¥ã€ç­‰
        var incKeywordMatch = normText.match(/(?:ä¸­ç|çé‡‘|è–ªæ°´|è–ªè³‡|ç´…åŒ…|åˆ©æ¯|æ”¶å…¥|income)[^\d]*(\d+)(?:\s*(?:å…ƒ|å¡Š))?/i);
        if (incKeywordMatch){
          var num = parseFloat(incKeywordMatch[1].replace(/,/g, ''));
          if (!isNaN(num)) income += num;
          continue;
        }
        
        // 2. åŒ¹é…æ”¶å…¥æ ¼å¼: ã€Œ+1000ã€æˆ–ã€Œæ•¸å­—+æ”¶å…¥ã€
        var incMatch = normText.match(/(?:^|\s)\+(\d+)(?:\s*(?:å…ƒ|å¡Š))?(?:\s|$)/i);
        if (incMatch){
          var num = parseFloat(incMatch[1].replace(/,/g, ''));
          if (!isNaN(num)) income += num;
          continue;
        }

        // 3. åŒ¹é…æ”¯å‡º: ã€Œ-500ã€æˆ–ã€Œæ”¯å‡º500ã€
        var expMatch = normText.match(/(?:^|\s)-(\d+)(?:\s*(?:å…ƒ|å¡Š|æ”¯å‡º|ex))?|(\d+)(?:\s*(?:å…ƒ|å¡Š|æ”¯å‡º|ex))(?:\s|$)/i);
        if (expMatch){
            var numStr = expMatch[1] || expMatch[2]; // å–åŒ¹é…åˆ°çš„ç¬¬ä¸€å€‹æ•¸å­—
            var num = parseFloat(numStr.replace(/,/g, ''));
            if (!isNaN(num)) expense += num;
        }
      }
      return { income: parseFloat(income.toFixed(2)), expense: parseFloat(expense.toFixed(2)) };
    }

    
    
    // ===== è¨˜å¸³åŠŸèƒ½ =====
    function loadAccounting(iso){
      try {
        return JSON.parse(localStorage.getItem('accounting:' + iso) || 'null') || [];
      } catch(e){
        return [];
      }
    }
    
    function saveAccounting(iso, entries){
      if (entries.length > 0){
        localStorage.setItem('accounting:' + iso, JSON.stringify(entries));
      } else {
        localStorage.removeItem('accounting:' + iso);
      }
    }
    
    function parseAccounting(text){
      var lines = text.split(/\r?\n/).map(function(x){ return x.trim(); }).filter(Boolean);
      var entries = [];
      
      for (var i=0; i<lines.length; i++){
        var line = lines[i];
        
        // åŒ¹é…ï¼šè²·XXX Nå…ƒã€XXX Nå…ƒã€è²·XXX $N
        var match = line.match(/(?:è²·|è³¼è²·)?(.+?)(\d+)(?:å…ƒ|\$)/);
        if (match){
          var name = match[1].trim();
          var amount = parseFloat(match[2]);
          
          if (name && !isNaN(amount) && amount > 0){
            // æ’é™¤æ”¶æ”¯æ ¼å¼ï¼ˆ+1000ã€-500ã€æ”¶å…¥ã€æ”¯å‡ºï¼‰
            if (!/^[\+\-]/.test(name) && !/æ”¶å…¥|æ”¯å‡º|in|ex/i.test(name)){
              entries.push({
                name: name,
                amount: amount,
                timestamp: Date.now()
              });
            }
          }
        }
      }
      
      return entries;
    }
    
    function renderAccountingDetails(){
      if (!state.currentISO || !accountingDetailsDiv) return;
      
      var entries = loadAccounting(state.currentISO);
      
      if (entries.length === 0){
        accountingDetailsDiv.style.display = 'none';
        return;
      }
      
      accountingDetailsDiv.style.display = 'block';
      
      var total = 0;
      var html = '<div class="sectionTitle">ğŸ“ ç•¶æ—¥è¨˜å¸³æ˜ç´°</div>';
      html += '<div class="chips" style="margin-top:.5rem">';
      
      entries.forEach(function(entry, index){
        total += entry.amount;
        html += '<div class="chip">';
        html += entry.name + ' $' + entry.amount.toFixed(0);
        html += '<button data-index="' + index + '">Ã—</button>';
        html += '</div>';
      });
      
      html += '</div>';
      html += '<div class="row" style="margin-top:.5rem"><span class="sectionTitle">ç¸½è¨ˆï¼š$' + total.toFixed(0) + '</span></div>';
      
      accountingDetailsDiv.innerHTML = html;
      
      // ç¶å®šåˆªé™¤äº‹ä»¶
      accountingDetailsDiv.querySelectorAll('button[data-index]').forEach(function(btn){
        btn.addEventListener('click', function(){
          var index = parseInt(btn.dataset.index);
          entries.splice(index, 1);
          saveAccounting(state.currentISO, entries);
          renderAccountingDetails();
          renderCalendar();
        });
      });
    }
    
    function addDays(dt, n){ var d = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate()); d.setDate(d.getDate()+n); return d; }

    // è¨ˆç®—æ—¥æœŸç¯„åœçš„ç¸½æ”¶æ”¯
    function calculateSummary(start, end){
      var totalIncome = 0;
      var totalExpense = 0;
      
      var cur = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      var endDate = new Date(end.getFullYear(), end.getMonth(), end.getDate()); // ç¢ºä¿æ˜¯æ—¥æœŸå°è±¡

      while (cur <= endDate){
        var iso = isoFromDate(cur);
        var amounts = loadAmounts(iso);
        totalIncome += amounts.income;
        totalExpense += amounts.expense;
        cur.setDate(cur.getDate() + 1);
      }
      
      return { income: parseFloat(totalIncome.toFixed(2)), expense: parseFloat(totalExpense.toFixed(2)) };
    }
    
    // ä½¿ç”¨æ–° helper è¨ˆç®—æœˆåº¦ç¸½æ”¶æ”¯
    function getMonthSummary(y, m){
      var firstDay = new Date(y, m, 1);
      var lastDay = new Date(y, m + 1, 0);
      return calculateSummary(firstDay, lastDay);
    }
    
    // ===== IME guard & Debounced routing =====
    var isComposing = false;
    textNote.addEventListener('compositionstart', function(){ isComposing = true; });
    textNote.addEventListener('compositionupdate', function(){ isComposing = true; });
    textNote.addEventListener('compositionend', function(){ isComposing = false; scheduleRoute(300); });

    var tDebounce=null;
    function scheduleRoute(wait){
      if (typeof wait !== 'number') wait = 700;
      clearTimeout(tDebounce);
      tDebounce = setTimeout(function(){
        if (isComposing) return;
        copyAndSave(textNote.value || '');
      }, wait);
    }

    function copyAndSave(fullText){
      copyDatedClauses(fullText);
      var text = (textNote.value || '').trim();
      
      var amounts = parseAmounts(text);
      var accounting = parseAccounting(text);
      
      if (!text && amounts.income === 0 && amounts.expense === 0){ 
        localStorage.removeItem('note:' + state.currentISO);
        localStorage.removeItem('amounts:' + state.currentISO); 
        setIndex(state.currentISO, false);
        setAmountIndex(state.currentISO, false);
      } else {
        saveNote(state.currentISO, { text:text });
        setIndex(state.currentISO, true);
        
        if (amounts.income > 0 || amounts.expense > 0) {
          localStorage.setItem('amounts:' + state.currentISO, JSON.stringify(amounts));
          setAmountIndex(state.currentISO, true);
        } else {
          localStorage.removeItem('amounts:' + state.currentISO);
          setAmountIndex(state.currentISO, false);
        }
      }
      
      saveAccounting(state.currentISO, accounting);
      renderCalendar();
      renderAccountingDetails();
    }
    // ... (end of copyAndSave and utility functions) ...

    // ===== Parsing & normalization (ä¿æŒä¸è®Š) =====
    function splitClauses(text){
      var parts = text.split(/\n|ã€‚|ï¼›|;|\r/g);
      var out = [];
      for (var i=0;i<parts.length;i++){
        var xs = parts[i].split(/ï¼Œ/g);
        for (var j=0;j<xs.length;j++){
          var z = xs[j].trim();
          if (z) out.push(z);
        }
      }
      return out;
    }
    function normalizeFW(s){
      var fwDigits = 'ï¼ï¼‘ï¼’ï¼“ï¼”ï¼•ï¼–ï¼—ï¼˜ï¼™';
      var out = '';
      for (var i=0;i<s.length;i++){
        var ch = s[i];
        var idx = fwDigits.indexOf(ch);
        if (idx >= 0) out += String(idx);
        else if (ch === 'ï¼š') out += ':';
        else if (ch === 'ï¼') out += '/';
        else if (ch === 'ï¼') out += '-';
        else if (ch === 'ï¼') out += '.';
        else out += ch;
      }
      return out;
    }
    var WEEKMAP = {'æ—¥':0,'å¤©':0,'ä¸€':1,'äºŒ':2,'ä¸‰':3,'å››':4,'äº”':5,'å…­':6};
    function setWeek(dt, targetDow, nextWeek){
      var cur = dt.getDay();
      var diff = targetDow - cur;
      if (nextWeek){ diff += (diff<=0 ? 7 : 7); }
      else { if (diff<0) diff += 7; }
      return addDays(dt, diff);
    }
    function nextMonthDate(dt, day){
      var y = dt.getFullYear(), m = dt.getMonth();
      var d = new Date(y, m+1, day);
      return d;
    }

    function parseDateInfo(raw, now){
      var s = normalizeFW(raw).trim();
      if (!s) return null;
      if (/^(ä»Šå¤©|ä»Šæ—¥)(.*)$/.test(s)) { var t=s.match(/^(ä»Šå¤©|ä»Šæ—¥)(.*)$/); return { iso: isoFromDate(now), tail:(t[2]||'').trim() }; }
      if (/^(æ˜å¤©|ç¿Œæ—¥|éš”å¤©)(.*)$/.test(s)) { var t=s.match(/^(æ˜å¤©|ç¿Œæ—¥|éš”å¤©)(.*)$/); var d=addDays(now,1); return { iso: isoFromDate(d), tail:(t[2]||'').trim() }; }
      if (/^(å¾Œå¤©)(.*)$/.test(s)) { var t=s.match(/^(å¾Œå¤©)(.*)$/); var d2=addDays(now,2); return { iso: isoFromDate(d2), tail:(t[2]||'').trim() }; }
      var m1 = s.match(/^(20\d{2})[\/\-.](\d{1,2})[\/\-.](\d{1,2})(.*)$/);
      if (m1){ var y=parseInt(m1[1]), mo=parseInt(m1[2]), d=parseInt(m1[3]); if (mo>=1&&mo<=12&&d>=1&&d<=31) return { iso: isoOf(y, mo-1, d), tail:(m1[4]||'').trim() }; }
      var m2 = s.match(/^(\d{1,2})[\/\-.](\d{1,2})(.*)$/);
      if (m2){ var mo2=parseInt(m2[1]), d2=parseInt(m2[2]); if (mo2>=1&&mo2<=12&&d2>=1&&d2<=31) return { iso: isoOf(now.getFullYear(), mo2-1, d2), tail:(m2[3]||'').trim() }; }
      var m3 = s.match(/^(\d{1,2})æœˆ(\d{1,2})[æ—¥è™Ÿ](.*)$/);
      if (m3){ var mo3=parseInt(m3[1]), d3=parseInt(m3[2]); if (mo3>=1&&d3>=1&&mo3<=12&&d3<=31) return { iso: isoOf(now.getFullYear(), mo3-1, d3), tail:(m3[3]||'').trim() }; }
      var m4 = s.match(/^(\d{1,2})[æ—¥è™Ÿ](.*)$/);
      if (m4){ var d4=parseInt(m4[1]); if (d4>=1&&d4<=31) return { iso: isoOf(now.getFullYear(), now.getMonth(), d4), tail:(m4[2]||'').trim() }; }
      var m5 = s.match(/^(ä¸‹å€‹?æœˆ|ä¸‹æœˆ)(\d{1,2})[æ—¥è™Ÿ](.*)$/);
      if (m5){ var d5=parseInt(m5[2]); var nd = nextMonthDate(now, d5); return { iso: isoFromDate(nd), tail:(m5[3]||'').trim() }; }
      var m6 = s.match(/^(æœ¬é€±|é€™é€±|é€™å‘¨|ä¸‹é€±|ä¸‹å‘¨)?(é€±|æ˜ŸæœŸ|ç¦®æ‹œ)([æ—¥å¤©ä¸€äºŒä¸‰å››äº”å…­])(.*)$/);
      if (m6){
        var scope = m6[1]||''; var dowC = m6[3]; var rest = (m6[4]||'').trim();
        var targetDow = WEEKMAP[dowC];
        var dbase = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        var target = setWeek(dbase, targetDow, /ä¸‹é€±|ä¸‹å‘¨/.test(scope));
        return { iso: isoFromDate(target), tail: rest };
      }
      return null;
    }

    function parseTimeFrom(s){
      var t = s.trim();
      var r;
      r = t.match(/(ä¸Šåˆ|æ—©ä¸Š|æ¸…æ™¨|ä¸‹åˆ|ä¸­åˆ|æ™šä¸Š|AM|PM)?\s*(\d{1,2})[:ï¼š](\d{1,2})/i);
      if (r){
        var ap = r[1] ? r[1].toLowerCase() : '';
        var h = parseInt(r[2],10), m = parseInt(r[3],10);
        if (h<=24 && m<=59){
          var mins = adjustAmPm(h,m,ap);
          var norm = pad2(Math.floor(mins/60))+':'+pad2(mins%60);
          var rest = t.replace(r[0],'').trim();
          return { minutes: mins, norm: norm, rest: rest };
        }
      }
      r = t.match(/(ä¸Šåˆ|æ—©ä¸Š|æ¸…æ™¨|ä¸‹åˆ|ä¸­åˆ|æ™šä¸Š)?\s*(\d{1,2})é»(\d{1,2})?åˆ†?/);
      if (r){
        var ap2 = r[1] ? r[1].toLowerCase() : '';
        var h2 = parseInt(r[2],10), m2 = r[3]?parseInt(r[3],10):0;
        if (h2<=24 && m2<=59){
          var mins2 = adjustAmPm(h2,m2,ap2);
          var norm2 = pad2(Math.floor(mins2/60))+':'+pad2(mins2%60);
          var rest2 = t.replace(r[0],'').trim();
          return { minutes: mins2, norm: norm2, rest: rest2 };
        }
      }
      r = t.match(/(ä¸Šåˆ|æ—©ä¸Š|æ¸…æ™¨)?\s*(\d{1,2})(é»|æ™‚)/);
      if (r){
        var ap3 = r[1] ? r[1].toLowerCase() : '';
        var h3 = parseInt(r[2],10);
        if (h3<=24){
          var mins3 = adjustAmPm(h3,0,ap3);
          var norm3 = pad2(Math.floor(mins3/60))+':'+pad2(mins3%60);
          var rest3 = t.replace(r[0],'').trim();
          return { minutes: mins3, norm: norm3, rest: rest3 };
        }
      }
      r = t.match(/(AM|PM)\s*(\d{1,2})(?=\D|$)/i);
      if (r){
        var ap4 = r[1].toLowerCase();
        var h4 = parseInt(r[2],10);
        if (h4<=24){
          var mins4 = adjustAmPm(h4,0,ap4);
          var norm4 = pad2(Math.floor(mins4/60))+':'+pad2(mins4%60);
          var rest4 = t.replace(r[0],'').trim();
          return { minutes: mins4, norm: norm4, rest: rest4 };
        }
      }
      return null;
    }
    function adjustAmPm(h,m,ap){
      var hh = h, mm = m;
      if (!ap) return hh*60+mm;
      ap = ap.toLowerCase();
      if (ap.indexOf('ä¸‹åˆ')>=0 || ap.indexOf('ä¸­åˆ')>=0 || ap.indexOf('æ™šä¸Š')>=0 || ap.indexOf('pm')>=0){
        if (hh<12) hh += 12;
      } else if (ap.indexOf('ä¸Šåˆ')>=0 || ap.indexOf('æ—©ä¸Š')>=0 || ap.indexOf('æ¸…æ™¨')>=0 || ap.indexOf('am')>=0){
        if (hh===12) hh = 0;
      }
      return hh*60+mm;
    }

    function copyDatedClauses(fullText){
      var clauses = splitClauses(fullText);
      var now = new Date();
      for (var i=0;i<clauses.length;i++){
        var original = clauses[i];
        var info = parseDateInfo(original, now);
        if (!info) continue;
        var targetISO = info.iso;
        var tail = info.tail || '';
        var tinfo = parseTimeFrom(tail);
        var content, display;
        if (tinfo){
          content = tinfo.rest.trim();
          display = (tinfo.norm + ' ' + content).trim();
        } else {
          content = tail.trim();
          display = content;
        }
        if (!display) continue;
        var key = 'ingested:' + targetISO;
        var bag = []; try { bag = JSON.parse(localStorage.getItem(key)||'[]') || []; } catch(e){ bag=[]; }
        var fingerprint = 'v86|' + display;
        if (bag.indexOf(fingerprint) < 0){
          var note = loadNote(targetISO);
          var newText = (note.text ? (note.text + '\n') : '') + display;
          saveNote(targetISO, { text: newText });
          setIndex(targetISO, true);
          bag.push(fingerprint);
          localStorage.setItem(key, JSON.stringify(bag));
        }
      }
    }

    // ===== Preview (3 items, time-sorted, exclude dated directives) =====
    function normalizeFWLine(line){ return normalizeFW(line||'').trim(); }
    function isDatedLine(line){
      var s = normalizeFWLine(line);
      if (!s) return false;
      if (/^(20\d{2})[\/\-.]\d{1,2}[\/\-.]\d{1,2}/.test(s)) return true;
      if (/^\d{1,2}[\/\-.]\d{1,2}(?!\d)/.test(s)) return true;
      if (/^\d{1,2}æœˆ\d{1,2}[æ—¥è™Ÿ]/.test(s)) return true;
      if (/^ä¸‹å€‹?æœˆ\d{1,2}[æ—¥è™Ÿ]/.test(s)) return true;
      if (/^(æœ¬é€±|é€™é€±|é€™å‘¨|ä¸‹é€±|ä¸‹å‘¨)?(é€±|æ˜ŸæœŸ|ç¦®æ‹œ)[æ—¥å¤©ä¸€äºŒä¸‰å››äº”å…­]/.test(s)) return true;
      if (/^(ä»Šå¤©|ä»Šæ—¥|æ˜å¤©|ç¿Œæ—¥|éš”å¤©|å¾Œå¤©)/.test(s)) return true;
      return false;
    }
    function parseTimeFromLine(line){
      var t = parseTimeFrom(line||'');
      return t ? t.minutes : null;
    }
    function previewLinesForISO(iso, maxLines){
      var note = loadNote(iso);
      var lines = [];
      if (note && note.text){
        lines = note.text.split(/\r?\n/).map(function(x){ return x.trim(); }).filter(Boolean);
      }
      // dedupe
      var seen = {}; var uniq = [];
      for (var i=0;i<lines.length;i++){ var k=lines[i]; if (!seen[k]){ seen[k]=1; uniq.push(k);} }
      var withTime = [], withoutTime = [];
      for (var j=0;j<uniq.length;j++){
        if (isDatedLine(uniq[j])) continue;
        var mins = parseTimeFromLine(uniq[j]);
        if (mins===null) withoutTime.push(uniq[j]); else withTime.push({line:uniq[j], mins:mins});
      }
      withTime.sort(function(a,b){ return a.mins - b.mins; });
      var ordered = withTime.map(function(x){ return x.line; }).concat(withoutTime);
      // ã€ä¿®æ­£ 1 ç¢ºä¿ã€‘éæ¿¾æ‰é‡‘é¡ç›¸é—œçš„èªå¥ (ç¢ºä¿æ—¥æ›†ä¸­ä¸é¡¯ç¤ºæ¯æ—¥æ”¶æ”¯ç´°ç¯€å…§å®¹)
      var filtered = ordered.filter(function(line){
          var normLine = normalizeFW(line);
          // éæ¿¾æ”¶æ”¯æ ¼å¼ï¼š+1000ã€-500ã€æ”¶å…¥1000ã€æ”¯å‡º500ç­‰
          if (/^[\+\-]\d+/.test(normLine.trim())) return false; // éæ¿¾ +1000ã€-500
          if (/(?:æ”¶å…¥|æ”¯å‡º|in|ex)/i.test(normLine)) return false; // éæ¿¾åŒ…å«æ”¶å…¥/æ”¯å‡ºé—œéµå­—
          // éæ¿¾å”è©©æ ¼å¼ï¼šåŒ…å« â€”â€” å’Œã€Šã€‹çš„è¡Œ
          if (/â€”â€”.*ã€Š.*ã€‹/.test(line)) return false; // éæ¿¾å”è©©
          return true;
      });
      return filtered.slice(0, maxLines);
    }

    // ===== Calendar render (ä¿®æ­£é€±ç´¯è¨ˆé‚è¼¯) =====
    function renderCalendar(){
      var first = new Date(state.y, state.m, 1);
      var startDay = first.getDay();
      var last = new Date(state.y, state.m + 1, 0);
      var days = last.getDate();

      monthLabel.textContent = state.y + 'å¹´ ' + (state.m+1) + 'æœˆ';
      grid.innerHTML = '';
      var today = new Date();
      var todayISO = isoFromDate(today);

      for (var i=0;i<startDay;i++) grid.appendChild(document.createElement('div'));

      for (var d=1; d<=days; d++){
        var iso = isoOf(state.y, state.m, d);

        var cell = document.createElement('div');
        cell.className = 'cell';
        cell.dataset.iso = iso;
        if (iso === todayISO) cell.classList.add('today');
        if (state.currentISO === iso) cell.classList.add('selected');
        
        // ã€ä¿®æ­£ 2ã€‘åœ¨é€±æ—¥é¡¯ç¤ºå‰ä¸€é€± (ä¸Šé€±æ—¥åˆ°ä¸Šé€±å…­) çš„æ·¨é¡ç¸½å’Œ (åªé¡¯ç¤ºçµ•å°å€¼ï¼Œçµ±ä¸€è—è‰²)
        var currentDate = new Date(state.y, state.m, d);
        if (currentDate.getDay() === 0) { // 0=æ—¥
          var previousSunday = addDays(currentDate, -7); // ä¸Šé€±æ—¥ (å‰ä¸€é€±çš„é–‹å§‹)
          var previousSaturday = addDays(currentDate, -1); // ä¸Šé€±å…­ (å‰ä¸€é€±çš„çµæŸ)
          
          var weekSummary = calculateSummary(previousSunday, previousSaturday); 
          
          var weekNet = weekSummary.income - weekSummary.expense;

          if (weekSummary.income !== 0 || weekSummary.expense !== 0) {
            // ä¿®æ­£: åƒ…é¡¯ç¤ºæ·¨é¡çš„çµ•å°å€¼æ•¸å­—ï¼Œä¸å¸¶æ­£è² è™Ÿï¼Œè—è‰²ï¼Œä¸”ç§»é™¤æ¨™ç±¤
            var netDisplay = Math.abs(weekNet).toLocaleString(); // çµ•å°å€¼ï¼Œä¸é¡¯ç¤ºæ­£è² è™Ÿ
            var netColor = 'var(--amount)'; // å§‹çµ‚ä½¿ç”¨è—è‰²
            
            var summaryHtml = '<div class="preview" style="color:' + netColor + '; font-weight:700; text-align:center; padding-top:2px; font-size:.9rem;">' +
                              netDisplay + // <-- åƒ…é¡¯ç¤ºæ•¸å­—
                              '</div>';
            
            cell.insertAdjacentHTML('beforeend', summaryHtml);
          }
        }

        var header = document.createElement('header');
        var numWrap = document.createElement('div');
        numWrap.className = 'day-num';
        numWrap.textContent = String(d);
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æ”¶æ”¯æˆ–è¨˜å¸³æ•¸æ“šï¼Œé¡¯ç¤ºè—è‰²é»
        var amounts = loadAmounts(iso);
        var accounting = loadAccounting(iso);
        var hasAmount = amounts.income > 0 || amounts.expense > 0 || accounting.length > 0;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰æ–‡å­—å…§å®¹ï¼ˆé ç´„/è¡Œç¨‹ï¼‰ï¼Œé¡¯ç¤ºç´…è‰²é»
        var note = loadNote(iso);
        var hasNote = note.text && note.text.trim().length > 0;

        if (hasAmount){
          var dot = document.createElement('span');
          dot.className = 'amount-dot'; // è—è‰²æ”¶æ”¯é»
          numWrap.appendChild(dot);
        }
        
        if (hasNote){
          var redDot = document.createElement('span');
          redDot.className = 'note-dot'; // ç´…è‰²é ç´„é»
          numWrap.appendChild(redDot);
        }
        
        header.appendChild(numWrap);
        header.appendChild(document.createElement('div'));
        cell.appendChild(header);

        // é¡¯ç¤ºç­†è¨˜é è¦½ (å·²éæ¿¾æ”¶æ”¯é‡‘é¡çš„é‚è¼¯ï¼Œç¬¦åˆè¦æ±‚ 1)
        var previews = previewLinesForISO(iso, 3);
        for (var i2=0;i2<previews.length;i2++){
          var pv = document.createElement('div');
          pv.className = 'preview';
          pv.textContent = previews[i2];
          cell.appendChild(pv);
        }

        cell.addEventListener('click', (function(isoCopy, cellRef){
          return function(){
            openNote(isoCopy);
            if (state.selectedCell) state.selectedCell.classList.remove('selected');
            state.selectedCell = cellRef;
            state.selectedCell.classList.add('selected');
          };
        })(iso, cell));

        grid.appendChild(cell);
      }
    }

    function openNote(iso){
      state.currentISO = iso;
      var note = loadNote(iso);
      textNote.value = note.text || '';
      renderAccountingDetails();
      
      // å¦‚æœæ˜¯æ˜ŸæœŸæ—¥ä¸”æ–‡å­—æ¬„ç‚ºç©ºï¼Œæ’å…¥å”è©©ï¼ˆåªåœ¨ç•¶å¤©æ‰æ’å…¥ï¼‰
      var date = new Date(iso);
      var today = new Date();
      today.setHours(0, 0, 0, 0); // è¨­å®šç‚ºç•¶å¤©çš„ 00:00:00
      var clickedDate = new Date(date);
      clickedDate.setHours(0, 0, 0, 0);
      
      // åªæœ‰åœ¨é»æ“Šçš„æ—¥æœŸæ˜¯ä»Šå¤©ï¼Œä¸”æ˜¯æ˜ŸæœŸæ—¥ï¼Œä¸”æ–‡å­—æ¬„ç‚ºç©ºæ™‚ï¼Œæ‰æ’å…¥å”è©©
      if (clickedDate.getTime() === today.getTime() && date.getDay() === 0 && !note.text) {
        insertPoem();
      }
      
      textNote.focus();
    }

    prevMonth.addEventListener('click', function(){
      state.m--; if (state.m < 0){ state.m = 11; state.y--; } renderCalendar();
    });
    nextMonth.addEventListener('click', function(){
      state.m++; if (state.m > 11){ state.m = 0; state.y++; } renderCalendar();
    });

    // Input events
    textNote.addEventListener('input', function(){
      if (isComposing) return;
      scheduleRoute(700);
    });
    textNote.addEventListener('paste', function(){
      setTimeout(function(){ scheduleRoute(300); }, 0);
    });
    textNote.addEventListener('blur', function(){
      if (isComposing) return;
      scheduleRoute(0);
    });

    // Export to PDF
    exportBtn.addEventListener('click', function(){
      if (!state.currentISO) return;
      var note = loadNote(state.currentISO);
      var win = window.open('', '_blank');
      if (!win) { alert('è«‹å…è¨±å½ˆå‡ºè¦–çª—ä»¥åŒ¯å‡º PDFã€‚'); return; }
      var noteText = note.text || '';
      var amounts = loadAmounts(state.currentISO);
      
      var amountSummary = '';
      if (amounts.income > 0 || amounts.expense > 0) {
          amountSummary = '\n\n--- ğŸ“… æ”¶æ”¯ç¸½è¨ˆ ---\næ”¶å…¥: ' + amounts.income.toLocaleString() + '\næ”¯å‡º: ' + amounts.expense.toLocaleString() + '\n---';
      }

      var title = 'æ¯æ—¥ç­†è¨˜ ' + state.currentISO;
      var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>'+title+'</title>' +
                 '<style>body{font-family:-apple-system,BlinkMacSystemFont,Roboto,\"Noto Sans TC\",\"PingFang TC\",\"Microsoft JhengHei",sans-serif;margin:24px;line-height:1.6}h1{font-size:18px;margin:0 0 12px}p{white-space:pre-wrap}</style>' +
                 '</head><body>' +
                 '<h1>'+title+'</h1>' +
                 '<p>' + escapeHtml(noteText + amountSummary) + '</p>' +
                 '<script>setTimeout(function(){window.print()}, 300);<\/script>' +
                 '</body></html>';
      win.document.open();
      win.document.write(html);
      win.document.close();
    });

    function escapeHtml(s){
      return s.replace(/[&<>"]/g, function(c){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c];
      });
    }

    // Install helper
    installBtn.addEventListener('click', function(){
      alert('åœ¨ iPad çš„ Safari ä»¥ã€Œåˆ†äº«ã€â†’ã€ŒåŠ å…¥ä¸»ç•«é¢ã€å³å¯å®‰è£ã€‚');
    });

    // ===== "æ¯é€±æ´»å‹•å®‰æ’" popover (multi-date + date-range) (ä¿æŒä¸è®Š) =====
    openPlanBtn.addEventListener('click', function(){
      var rect = openPlanBtn.getBoundingClientRect();
      var bodyRect = document.body.getBoundingClientRect();
      planPop.style.left = Math.max(8, rect.left - bodyRect.left) + 'px';
      planPop.style.top = (rect.bottom + 8 + window.scrollY) + 'px';
      buildPlanPop();
      planPop.style.display = 'block';
    });
    
    function buildPlanPop(){
      var today = new Date();
      var yyyy = today.getFullYear(), mm = pad2(today.getMonth()+1), dd = pad2(today.getDate());
      planPop.innerHTML = ''
        + '<div class="row"><span class="sectionTitle">å–®æ—¥</span></div>'
        + '<div class="row">'
        +   '<label class="muted" style="width:60px">æ—¥æœŸ</label>'
        +   '<input id="sdDate" type="date" value="'+yyyy+'-'+mm+'-'+dd+'">'
        +   '<button id="sdAdd">åŠ å…¥æ—¥æœŸ</button>'
        + '</div>'
        + '<div class="row"><span class="sectionTitle">æ—¥æœŸç¯„åœ</span></div>'
        + '<div class="row">'
        +   '<label class="muted" style="width:60px">èµ·å§‹</label><input id="rgStart" type="date" value="'+yyyy+'-'+mm+'-'+dd+'">'
        +   '<label class="muted" style="width:48px">çµæŸ</label><input id="rgEnd" type="date" value="'+yyyy+'-'+mm+'-'+dd+'">'
        +   '<button id="rgAdd">åŠ å…¥ç¯„åœ</button>'
        + '</div>'
        + '<div class="row"><div id="mdList" class="chips" aria-live="polite"></div></div>'
        + '<div class="row"><label class="muted" style="width:60px">å…§å®¹</label><input id="mdText" type="text" placeholder=""></div>'
        + '<div class="row" style="justify-content:flex-end; gap:.5rem"><button id="mdInsert">æ’å…¥</button><button id="mdClose" class="ghost">é—œé–‰</button></div>';

      var pickSet = new Set();

      function addISO(iso){
        if (!iso) return;
        pickSet.add(iso);
        renderChips();
      }
      function addRangeISO(a, b){
        if (!a || !b) return;
        var s = new Date(a), e = new Date(b);
        if (e < s){ var tmp=s; s=e; e=tmp; }
        var cur = new Date(s.getFullYear(), s.getMonth(), s.getDate());
        while (cur <= e){
          addISO(isoFromDate(cur));
          cur.setDate(cur.getDate()+1);
        }
      }
      function renderChips(){
        var list = document.getElementById('mdList');
        list.innerHTML = '';
        Array.from(pickSet).sort().forEach(function(iso){
          var parts = iso.split('-'); var m = parseInt(parts[1],10), d = parseInt(parts[2],10);
          var chip = document.createElement('span'); chip.className='chip';
          chip.innerHTML = m + '/' + d + '<button title="ç§»é™¤" data-iso="'+iso+'">Ã—</button>';
          list.appendChild(chip);
        });
        list.querySelectorAll('button[data-iso]').forEach(function(btn){
          btn.addEventListener('click', function(){ pickSet.delete(btn.dataset.iso); renderChips(); });
        });
      }

      document.getElementById('sdAdd').onclick = function(){
        var iso = document.getElementById('sdDate').value;
        addISO(iso);
      };
      document.getElementById('rgAdd').onclick = function(){
        var a = document.getElementById('rgStart').value;
        var b = document.getElementById('rgEnd').value;
        addRangeISO(a, b);
      };
      document.getElementById('mdClose').onclick = function(){ planPop.style.display='none'; };

      document.getElementById('mdInsert').onclick = function(){
        var text = (document.getElementById('mdText').value||'').trim();
        if (!text || pickSet.size===0){ planPop.style.display='none'; return; }
        var ordered = Array.from(pickSet).sort();
        
        // ç›´æ¥å„²å­˜åˆ°ç›®æ¨™æ—¥æœŸï¼Œä¸æ’å…¥åˆ°ç•¶å‰æ–‡å­—æ¬„
        ordered.forEach(function(iso){
          var note = loadNote(iso);
          // åœ¨æ–‡å­—æ¬„ç¬¬ä¸€æ’æ’å…¥è¡Œç¨‹
          if (note.text) {
            note.text = text + '\n' + note.text;
          } else {
            note.text = text;
          }
          saveNote(iso, note);
          setIndex(iso, true);
        });
        
        planPop.style.display='none';
        
        // è·³è½‰åˆ°ç¬¬ä¸€å€‹ç›®æ¨™æ—¥æœŸ
        var firstISO = ordered[0];
        openNote(firstISO);
        renderCalendar();
      };
    }

    function insertLinesAtCursor(lines){
      var el = textNote;
      var start = el.selectionStart, end = el.selectionEnd;
      var txt = el.value;
      var before = txt.slice(0,start);
      var after  = txt.slice(end);
      var block = lines.join('\n');
      var sepBefore = (before.length && before[before.length-1] !== '\n') ? '\n' : '';
      var sepAfter = (after.length && after[0] !== '\n') ? '\n' : '';
      el.value = before + sepBefore + block + sepAfter + after;
      el.focus();
      el.selectionStart = el.selectionEnd = (before + sepBefore + block).length;
    }


    // ===== "æ”¶æ”¯å ±è¡¨" popover (ä¿æŒå ±è¡¨é‚è¼¯ä¸è®Š) =====
    openReportBtn.addEventListener('click', function(){
      var rect = openReportBtn.getBoundingClientRect();
      var bodyRect = document.body.getBoundingClientRect();
      reportPop.style.left = Math.max(8, rect.left - bodyRect.left) + 'px';
      reportPop.style.top = (rect.bottom + 8 + window.scrollY) + 'px';
      buildReportPop();
      reportPop.style.display = 'block';
    });

    function buildReportPop(){
      var html = '<div class="row"><span class="sectionTitle">ğŸ“Š ' + state.y + 'å¹´ ' + (state.m+1) + 'æœˆ æ”¶æ”¯å ±è¡¨</span></div>';
      
      // 1. æœˆåº¦ç¸½è¨ˆ
      var monthSummary = getMonthSummary(state.y, state.m); // ä½¿ç”¨ä¿®æ­£å¾Œçš„ getMonthSummary
      var monthNet = monthSummary.income - monthSummary.expense;
      
      html += '<div class="row" style="margin-top:.7rem; align-items:flex-start">'
            +   '<span class="sectionTitle" style="width:60px; flex-shrink:0">æœˆç¸½çµ</span>'
            +   '<div style="flex:1">'
            +     '<div class="chip" style="background:#dbeafe; color:var(--primary)">æ”¶å…¥: ' + monthSummary.income.toLocaleString() + '</div> '
            +     '<div class="chip" style="background:#fee2e2; color:var(--danger)">æ”¯å‡º: ' + monthSummary.expense.toLocaleString() + '</div> '
            +     '<div class="chip" style="background:#e0f2f1; color:' + (monthNet >= 0 ? 'green' : 'var(--danger)') + '">æ·¨é¡: ' + monthNet.toLocaleString() + '</div>'
            +   '</div>'
            + '</div>';
      
      // 2. æ¯é€±å ±è¡¨
      html += '<div class="row" style="margin-top:.7rem"><span class="sectionTitle">æ¯é€±ç´°é … (é€±æ—¥åˆ°é€±å…­)</span></div>';
      
      var lastDayOfMonth = new Date(state.y, state.m + 1, 0);
      var firstDayOfMonth = new Date(state.y, state.m, 1);
      var weeks = [];
      var cur = new Date(firstDayOfMonth.getFullYear(), firstDayOfMonth.getMonth(), firstDayOfMonth.getDate());
      
      // æ‰¾åˆ°ç•¶æœˆç¬¬ä¸€å¤©æ‰€åœ¨çš„é€±æ—¥
      var startWeek = addDays(cur, -cur.getDay());
      
      var weekStart = new Date(startWeek);
      
      while (weekStart <= lastDayOfMonth || weekStart.getMonth() === state.m || weekStart.getDay() !== 0){
          var weekEnd = new Date(weekStart);
          var isLastDay = isoFromDate(weekStart) === isoFromDate(lastDayOfMonth);

          if (weekStart.getDay() === 6 || isLastDay){ // é€±å…­æˆ–ç•¶æœˆæœ€å¾Œä¸€å¤©çµæŸ
              
              var weekBegin = addDays(weekEnd, -6);
              
              // ç¢ºä¿é€±èµ·å§‹æ—¥ä¸è¶…éç•¶æœˆç¬¬ä¸€å¤©
              if (weekBegin < firstDayOfMonth && weekStart >= firstDayOfMonth) {
                  weekBegin = firstDayOfMonth; 
              } else if (weekBegin.getMonth() !== weekStart.getMonth() && weekStart.getMonth() === state.m) {
                  // å¦‚æœé€±é–‹å§‹æ—¥åœ¨ä¸Šå€‹æœˆï¼Œä¸”é€±çµæŸæ—¥åœ¨é€™å€‹æœˆï¼Œå‰‡å¾é€™å€‹æœˆçš„ç¬¬ä¸€å¤©é–‹å§‹è¨ˆç®—
                  weekBegin = firstDayOfMonth; 
              } else if (weekStart.getMonth() !== state.m) {
                  // å¿½ç•¥è·¨è¶Šåˆ°ä¸‹å€‹æœˆçš„æ—¥æœŸ
                  // å¦‚æœ weekStartå·²ç¶“æ˜¯ä¸‹å€‹æœˆï¼Œä¸¦ä¸”å®ƒä¸æ˜¯å¾æœ¬æœˆé–‹å§‹è¨ˆç®—çš„ï¼Œå‰‡è·³å‡ºå¾ªç’°
                  if (weekBegin.getMonth() !== state.m) break;
              }


              var weekSummary = calculateSummary(weekBegin, weekEnd);

              var weekNet = weekSummary.income - weekSummary.expense;
              
              weeks.push({
                  start: weekBegin,
                  end: weekEnd,
                  income: weekSummary.income,
                  expense: weekSummary.expense,
                  net: weekNet
              });
          }

          weekStart.setDate(weekStart.getDate() + 1); // ç§»åˆ°ä¸‹ä¸€å¤©

          if(weekStart > addDays(lastDayOfMonth, 6)) break; // é˜²æ­¢ç„¡é™å¾ªç’°
      }

      html += '<table style="width:100%; border-collapse:collapse; font-size:.9rem; margin-top:.5rem">'
            +   '<thead><tr style="background:var(--surface)">'
            +     '<th style="border:1px solid var(--border); padding:.4rem; text-align:left">å€é–“</th>'
            +     '<th style="border:1px solid var(--border); padding:.4rem">æ”¶å…¥</th>'
            +     '<th style="border:1px solid var(--border); padding:.4rem">æ”¯å‡º</th>'
            +     '<th style="border:1px solid var(--border); padding:.4rem">æ·¨é¡</th>'
            +   '</tr></thead><tbody>';
      
      weeks.forEach(function(w){
          var startM = w.start.getMonth()+1, startD = w.start.getDate();
          var endM = w.end.getMonth()+1, endD = w.end.getDate();
          var startStr = (w.start.getFullYear() !== state.y) ? w.start.getFullYear() + '/' : '';
          var endStr = (w.end.getFullYear() !== state.y) ? w.end.getFullYear() + '/' : '';

          html += '<tr>'
                +   '<td style="border:1px solid var(--border); padding:.4rem">' + startStr + startM + '/' + startD + ' - ' + endStr + endM + '/' + endD + '</td>'
                +   '<td style="border:1px solid var(--border); padding:.4rem; text-align:right; color:var(--primary)">' + w.income.toLocaleString() + '</td>'
                +   '<td style="border:1px solid var(--border); padding:.4rem; text-align:right; color:var(--danger)">' + w.expense.toLocaleString() + '</td>'
                +   '<td style="border:1px solid var(--border); padding:.4rem; text-align:right; font-weight:700; color:' + (w.net >= 0 ? 'green' : 'var(--danger)') + '">' + w.net.toLocaleString() + '</td>'
                + '</tr>';
      });
      
      html += '</tbody></table>';
      
      html += '<div class="row" style="justify-content:flex-end; gap:.5rem; margin-top:1rem"><button id="rpClose" class="ghost">é—œé–‰</button></div>';

      reportPop.innerHTML = html;
      document.getElementById('rpClose').onclick = function(){ reportPop.style.display='none'; };
    }


    
    
    // ===== æˆ‘çš„ç­†è¨˜åŠŸèƒ½ =====
    var openMyNotesBtn = document.getElementById('openMyNotes');
    var myNotesPop = document.getElementById('myNotesPop');
    var currentEditingNoteId = null;
    var speechRecognition = null;
    var speechSynthesisUtterance = null;
    
    // è¼‰å…¥æ‰€æœ‰ç­†è¨˜
    function loadMyNotes(){
      try {
        return JSON.parse(localStorage.getItem('myNotes') || '[]');
      } catch(e){
        return [];
      }
    }
    
    // å„²å­˜æ‰€æœ‰ç­†è¨˜
    function saveMyNotes(notes){
      localStorage.setItem('myNotes', JSON.stringify(notes));
    }
    
    // é–‹å•Ÿç­†è¨˜è¦–çª—
    openMyNotesBtn.onclick = function(){
      showNotesList();
      myNotesPop.style.display = 'block';
    };
    
    // é¡¯ç¤ºç­†è¨˜åˆ—è¡¨
    function showNotesList(){
      var notes = loadMyNotes();
      var html = '<div class="sectionTitle">ğŸ“ æˆ‘çš„ç­†è¨˜</div>';
      html += '<div class="row" style="margin-top:1rem"><button id="mnNew">â• æ–°å¢ç­†è¨˜</button><button id="mnClose" class="ghost">é—œé–‰</button></div>';
      
      if (notes.length === 0){
        html += '<div style="text-align:center; padding:3rem; color:var(--muted)">å°šç„¡ç­†è¨˜ï¼Œé»æ“Šã€Œæ–°å¢ç­†è¨˜ã€é–‹å§‹</div>';
      } else {
        html += '<div style="margin-top:1rem; display:grid; gap:.75rem">';
        notes.forEach(function(note, index){
          var date = new Date(note.created);
          var dateStr = date.getFullYear() + '/' + (date.getMonth()+1) + '/' + date.getDate() + ' ' + date.getHours() + ':' + String(date.getMinutes()).padStart(2,'0');
          var preview = note.content.substring(0, 80);
          html += '<div style="border:1px solid var(--border); border-radius:.5rem; padding:.75rem; cursor:pointer; background:#fff" data-note-id="' + note.id + '">';
          html += '<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem">';
          html += '<div style="font-weight:700; font-size:1rem">' + (note.title || 'ç„¡æ¨™é¡Œ') + '</div>';
          html += '<div style="font-size:.85rem; color:var(--muted)">' + dateStr + '</div>';
          html += '</div>';
          html += '<div style="color:var(--muted); font-size:.9rem">' + preview + '</div>';
          html += '</div>';
        });
        html += '</div>';
      }
      
      myNotesPop.innerHTML = html;
      
      document.getElementById('mnNew').onclick = function(){ createNewNote(); };
      document.getElementById('mnClose').onclick = function(){ myNotesPop.style.display='none'; };
      
      // ç¶å®šç­†è¨˜é»æ“Šäº‹ä»¶
      myNotesPop.querySelectorAll('[data-note-id]').forEach(function(card){
        card.onclick = function(){
          var noteId = card.getAttribute('data-note-id');
          openNoteEditor(noteId);
        };
      });
    }
    
    // å»ºç«‹æ–°ç­†è¨˜
    function createNewNote(){
      var notes = loadMyNotes();
      var newNote = {
        id: 'note_' + Date.now(),
        title: '',
        content: '',
        created: new Date().toISOString(),
        modified: new Date().toISOString()
      };
      notes.unshift(newNote);
      saveMyNotes(notes);
      openNoteEditor(newNote.id);
    }
    
    // é–‹å•Ÿç­†è¨˜ç·¨è¼¯å™¨
    function openNoteEditor(noteId){
      currentEditingNoteId = noteId;
      var notes = loadMyNotes();
      var note = notes.find(function(n){ return n.id === noteId; });
      if (!note) return;
      
      var html = '<div class="sectionTitle">âœ’ï¸ ç·¨è¼¯ç­†è¨˜</div>';
      html += '<div class="row" style="margin-top:1rem; flex-wrap:wrap">';
      html += '<button id="mnSave">ğŸ’¾ å„²å­˜</button>';
      html += '<button id="mnVoice">ğŸ¤ èªéŸ³è¨˜éŒ„</button>';
      html += '<button id="mnRead">ğŸ”Š æœ—è®€æ–‡ç« </button>';
      html += '<button id="mnImport">ğŸ“… åŒ¯å…¥</button>';
      html += '<button id="mnExport">ğŸ“„ åŒ¯å‡º</button>';
      html += '<button id="mnDrawing" style="background:var(--primary); color:white">âœï¸ æ‰‹å¯«æ¨¡å¼</button>';
      html += '<button id="mnDelete" style="color:var(--danger)">ğŸ—‘ï¸ åˆªé™¤</button>';
      html += '<button id="mnBack" class="ghost">â† è¿”å›åˆ—è¡¨</button>';
      html += '</div>';
      html += '<div id="recordingIndicator" style="display:none; margin-top:.5rem; padding:.5rem; background:#fee; border:1px solid #fcc; border-radius:.5rem; color:#c00">';
      html += '<span style="display:inline-block; width:8px; height:8px; border-radius:50%; background:#c00; animation:pulse 1.5s infinite; margin-right:.5rem"></span>';
      html += 'éŒ„éŸ³ä¸­...';
      html += '</div>';
      html += '<input type="text" id="mnTitle" placeholder="ç­†è¨˜æ¨™é¡Œ" value="' + (note.title || '') + '" style="width:100%; padding:.75rem; border:1px solid var(--border); border-radius:.5rem; font-size:1.1rem; font-weight:700; margin-top:1rem" />';
      html += '<textarea id="mnContent" placeholder="é–‹å§‹è¼¸å…¥æ‚¨çš„ç­†è¨˜å…§å®¹..." style="width:100%; min-height:400px; padding:.75rem; border:1px solid var(--border); border-radius:.5rem; font-size:1rem; line-height:1.6; resize:vertical; margin-top:1rem">' + (note.content || '') + '</textarea>';
      
      // æ‰‹å¯«æ¿å€åŸŸ
      html += '<div id="drawingArea" style="display:none; margin-top:1rem; border:1px solid var(--border); border-radius:.5rem; padding:1rem; background:#f9fafb">';
      html += '<div class="sectionTitle">âœï¸ æ‰‹å¯«æ¿</div>';
      html += '<div class="row" style="margin-top:.5rem; flex-wrap:wrap; gap:.5rem">';
      html += '<button id="drawPen" class="ghost" style="background:var(--primary); color:white">ğŸ–Šï¸ ç•«ç­†</button>';
      html += '<button id="drawEraser" class="ghost">ğŸ§¹ æ©¡çš®æ“¦</button>';
      html += '<input type="color" id="drawColor" value="#000000" style="width:60px; height:36px; border:1px solid var(--border); border-radius:.25rem; cursor:pointer" />';
      html += '<select id="drawSize" style="padding:.5rem; border:1px solid var(--border); border-radius:.25rem">';
      html += '<option value="2">ç´°ç­† (2px)</option>';
      html += '<option value="5" selected>ä¸­ç­† (5px)</option>';
      html += '<option value="10">ç²—ç­† (10px)</option>';
      html += '<option value="20">ç‰¹ç²— (20px)</option>';
      html += '</select>';
      html += '<button id="drawClear" class="ghost" style="color:var(--danger)">ğŸ—‘ï¸ æ¸…é™¤ç•«å¸ƒ</button>';
      html += '<button id="drawSave" class="ghost" style="background:var(--primary); color:white">ğŸ’¾ å„²å­˜æ‰‹å¯«</button>';
      html += '<button id="drawClose" class="ghost">é—œé–‰æ‰‹å¯«æ¿</button>';
      html += '</div>';
      html += '<canvas id="drawCanvas" width="800" height="600" style="width:100%; max-width:800px; height:auto; border:2px solid var(--border); border-radius:.5rem; margin-top:1rem; background:white; cursor:crosshair; touch-action:none"></canvas>';
      html += '<div id="drawingPreview" style="margin-top:1rem"></div>';
      html += '</div>';
      
      myNotesPop.innerHTML = html;
      
      document.getElementById('mnSave').onclick = function(){ saveCurrentNote(); };
      document.getElementById('mnVoice').onclick = function(){ toggleVoiceRecording(); };
      document.getElementById('mnRead').onclick = function(){ toggleReadAloud(); };
      document.getElementById('mnImport').onclick = function(){ importNote(); };
      document.getElementById('mnExport').onclick = function(){ exportNote(); };
      document.getElementById('mnDelete').onclick = function(){ deleteCurrentNote(); };
      document.getElementById('mnBack').onclick = function(){ showNotesList(); };
      document.getElementById('mnDrawing').onclick = function(){ toggleDrawingMode(); };
      
      // åˆå§‹åŒ–æ‰‹å¯«æ¿ï¼ˆå¦‚æœæœ‰å„²å­˜çš„æ‰‹å¯«å…§å®¹ï¼‰
      if (note.drawing){
        var preview = document.getElementById('drawingPreview');
        preview.innerHTML = '<div style="padding:.5rem; background:white; border:1px solid var(--border); border-radius:.5rem"><img src="' + note.drawing + '" style="max-width:100%; height:auto; border-radius:.25rem" /></div>';
      }
    }
    
    // å„²å­˜ç•¶å‰ç­†è¨˜
    function saveCurrentNote(){
      if (!currentEditingNoteId) return;
      var notes = loadMyNotes();
      var note = notes.find(function(n){ return n.id === currentEditingNoteId; });
      if (!note) return;
      
      note.title = document.getElementById('mnTitle').value;
      note.content = document.getElementById('mnContent').value;
      note.modified = new Date().toISOString();
      
      saveMyNotes(notes);
      alert('ç­†è¨˜å·²å„²å­˜');
    }
    
    // èªéŸ³è¨˜éŒ„
    function toggleVoiceRecording(){
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜åŠŸèƒ½ï¼Œè«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨');
        return;
      }
      
      if (speechRecognition && speechRecognition.started){
        speechRecognition.stop();
        return;
      }
      
      var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      speechRecognition = new SpeechRecognition();
      speechRecognition.lang = 'zh-TW';
      speechRecognition.continuous = true;
      speechRecognition.interimResults = true;
      
      speechRecognition.onstart = function(){
        speechRecognition.started = true;
        document.getElementById('recordingIndicator').style.display = 'block';
        document.getElementById('mnVoice').textContent = 'â¹ï¸ åœæ­¢éŒ„éŸ³';
      };
      
      speechRecognition.onresult = function(event){
        var transcript = '';
        for (var i = event.resultIndex; i < event.results.length; i++){
          transcript += event.results[i][0].transcript;
        }
        var textarea = document.getElementById('mnContent');
        if (textarea){
          textarea.value += transcript;
        }
      };
      
      speechRecognition.onend = function(){
        speechRecognition.started = false;
        var indicator = document.getElementById('recordingIndicator');
        if (indicator) indicator.style.display = 'none';
        var btn = document.getElementById('mnVoice');
        if (btn) btn.textContent = 'ğŸ¤ èªéŸ³è¨˜éŒ„';
      };
      
      speechRecognition.onerror = function(event){
        console.error('èªéŸ³è¾¨è­˜éŒ¯èª¤:', event.error);
        speechRecognition.started = false;
        var indicator = document.getElementById('recordingIndicator');
        if (indicator) indicator.style.display = 'none';
        var btn = document.getElementById('mnVoice');
        if (btn) btn.textContent = 'ğŸ¤ èªéŸ³è¨˜éŒ„';
      };
      
      speechRecognition.start();
    }
    
    // æœ—è®€æ–‡ç« 
    function toggleReadAloud(){
      if (!window.speechSynthesis){
        alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³åˆæˆåŠŸèƒ½');
        return;
      }
      
      if (window.speechSynthesis.speaking){
        window.speechSynthesis.cancel();
        document.getElementById('mnRead').textContent = 'ğŸ”Š æœ—è®€æ–‡ç« ';
        return;
      }
      
      var content = document.getElementById('mnContent').value;
      if (!content){
        alert('è«‹å…ˆè¼¸å…¥å…§å®¹');
        return;
      }
      
      speechSynthesisUtterance = new SpeechSynthesisUtterance(content);
      speechSynthesisUtterance.lang = 'zh-TW';
      speechSynthesisUtterance.rate = 1.0;
      speechSynthesisUtterance.pitch = 1.0;
      
      speechSynthesisUtterance.onstart = function(){
        document.getElementById('mnRead').textContent = 'â¹ï¸ åœæ­¢æœ—è®€';
      };
      
      speechSynthesisUtterance.onend = function(){
        document.getElementById('mnRead').textContent = 'ğŸ”Š æœ—è®€æ–‡ç« ';
      };
      
      window.speechSynthesis.speak(speechSynthesisUtterance);
    }
    
    // åŒ¯å…¥æ–‡ç« 
    function importNote(){
      var input = document.createElement('input');
      input.type = 'file';
      input.accept = '.txt,.md';
      
      input.onchange = function(e){
        var file = e.target.files[0];
        if (!file) return;
        
        var reader = new FileReader();
        reader.onload = function(event){
          var content = event.target.result;
          document.getElementById('mnContent').value = content;
          alert('æª”æ¡ˆå·²åŒ¯å…¥');
        };
        reader.readAsText(file);
      };
      
      input.click();
    }
    
    // åŒ¯å‡ºæ–‡ç« 
    function exportNote(){
      var title = document.getElementById('mnTitle').value || 'ç„¡æ¨™é¡Œ';
      var content = document.getElementById('mnContent').value;
      
      if (!content){
        alert('è«‹å…ˆè¼¸å…¥å…§å®¹');
        return;
      }
      
      var blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = title + '.txt';
      a.click();
      URL.revokeObjectURL(url);
    }
    
    // åˆªé™¤ç•¶å‰ç­†è¨˜
    function deleteCurrentNote(){
      if (!currentEditingNoteId) return;
      if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡ç­†è¨˜å—ï¼Ÿ')) return;
      
      var notes = loadMyNotes();
      notes = notes.filter(function(n){ return n.id !== currentEditingNoteId; });
      saveMyNotes(notes);
      showNotesList();
    }
    
    // ========== æ‰‹å¯«æ¿åŠŸèƒ½ ==========
    var drawingCanvas = null;
    var drawingCtx = null;
    var isDrawing = false;
    var drawingTool = 'pen'; // 'pen' or 'eraser'
    var drawingColor = '#000000';
    var drawingSize = 5;
    
    // åˆ‡æ›æ‰‹å¯«æ¨¡å¼
    function toggleDrawingMode(){
      var area = document.getElementById('drawingArea');
      var btn = document.getElementById('mnDrawing');
      
      if (area.style.display === 'none'){
        area.style.display = 'block';
        btn.textContent = 'âœ”ï¸ æ‰‹å¯«æ¨¡å¼';
        btn.style.background = '#10b981';
        initDrawingCanvas();
      } else {
        area.style.display = 'none';
        btn.textContent = 'âœï¸ æ‰‹å¯«æ¨¡å¼';
        btn.style.background = 'var(--primary)';
      }
    }
    
    // åˆå§‹åŒ–æ‰‹å¯«æ¿
    function initDrawingCanvas(){
      drawingCanvas = document.getElementById('drawCanvas');
      if (!drawingCanvas) return;
      
      drawingCtx = drawingCanvas.getContext('2d');
      
      // è¨­å®šç•«å¸ƒèƒŒæ™¯ç‚ºç™½è‰²
      drawingCtx.fillStyle = 'white';
      drawingCtx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
      
      // è¼‰å…¥å·²å„²å­˜çš„æ‰‹å¯«å…§å®¹
      var notes = loadMyNotes();
      var note = notes.find(function(n){ return n.id === currentEditingNoteId; });
      if (note && note.drawing){
        var img = new Image();
        img.onload = function(){
          drawingCtx.drawImage(img, 0, 0);
        };
        img.src = note.drawing;
      }
      
      // ç¶å®šå·¥å…·æŒ‰éˆ•
      document.getElementById('drawPen').onclick = function(){
        drawingTool = 'pen';
        updateToolButtons();
      };
      document.getElementById('drawEraser').onclick = function(){
        drawingTool = 'eraser';
        updateToolButtons();
      };
      document.getElementById('drawColor').oninput = function(){
        drawingColor = this.value;
        drawingTool = 'pen';
        updateToolButtons();
      };
      document.getElementById('drawSize').onchange = function(){
        drawingSize = parseInt(this.value);
      };
      document.getElementById('drawClear').onclick = function(){
        if (confirm('ç¢ºå®šè¦æ¸…é™¤æ•´å€‹ç•«å¸ƒå—ï¼Ÿ')){
          drawingCtx.fillStyle = 'white';
          drawingCtx.fillRect(0, 0, drawingCanvas.width, drawingCanvas.height);
        }
      };
      document.getElementById('drawSave').onclick = function(){
        saveDrawing();
      };
      document.getElementById('drawClose').onclick = function(){
        toggleDrawingMode();
      };
      
      // ç¶å®šæ»‘é¼ äº‹ä»¶
      drawingCanvas.addEventListener('mousedown', startDrawing);
      drawingCanvas.addEventListener('mousemove', draw);
      drawingCanvas.addEventListener('mouseup', stopDrawing);
      drawingCanvas.addEventListener('mouseout', stopDrawing);
      
      // ç¶å®šè§¸æ§äº‹ä»¶
      drawingCanvas.addEventListener('touchstart', handleTouchStart);
      drawingCanvas.addEventListener('touchmove', handleTouchMove);
      drawingCanvas.addEventListener('touchend', stopDrawing);
      
      updateToolButtons();
    }
    
    // æ›´æ–°å·¥å…·æŒ‰éˆ•ç‹€æ…‹
    function updateToolButtons(){
      var penBtn = document.getElementById('drawPen');
      var eraserBtn = document.getElementById('drawEraser');
      
      if (drawingTool === 'pen'){
        penBtn.style.background = 'var(--primary)';
        penBtn.style.color = 'white';
        eraserBtn.style.background = '';
        eraserBtn.style.color = '';
      } else {
        penBtn.style.background = '';
        penBtn.style.color = '';
        eraserBtn.style.background = 'var(--primary)';
        eraserBtn.style.color = 'white';
      }
    }
    
    // é–‹å§‹ç¹ªåœ–
    function startDrawing(e){
      isDrawing = true;
      var rect = drawingCanvas.getBoundingClientRect();
      var scaleX = drawingCanvas.width / rect.width;
      var scaleY = drawingCanvas.height / rect.height;
      var x = (e.clientX - rect.left) * scaleX;
      var y = (e.clientY - rect.top) * scaleY;
      
      drawingCtx.beginPath();
      drawingCtx.moveTo(x, y);
    }
    
    // ç¹ªåœ–
    function draw(e){
      if (!isDrawing) return;
      
      var rect = drawingCanvas.getBoundingClientRect();
      var scaleX = drawingCanvas.width / rect.width;
      var scaleY = drawingCanvas.height / rect.height;
      var x = (e.clientX - rect.left) * scaleX;
      var y = (e.clientY - rect.top) * scaleY;
      
      if (drawingTool === 'pen'){
        drawingCtx.strokeStyle = drawingColor;
        drawingCtx.lineWidth = drawingSize;
        drawingCtx.lineCap = 'round';
        drawingCtx.lineJoin = 'round';
      } else {
        drawingCtx.strokeStyle = 'white';
        drawingCtx.lineWidth = drawingSize * 2;
        drawingCtx.lineCap = 'round';
        drawingCtx.lineJoin = 'round';
      }
      
      drawingCtx.lineTo(x, y);
      drawingCtx.stroke();
    }
    
    // åœæ­¢ç¹ªåœ–
    function stopDrawing(){
      isDrawing = false;
      drawingCtx.beginPath();
    }
    
    // è™•ç†è§¸æ§é–‹å§‹
    function handleTouchStart(e){
      e.preventDefault();
      var touch = e.touches[0];
      var mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      drawingCanvas.dispatchEvent(mouseEvent);
    }
    
    // è™•ç†è§¸æ§ç§»å‹•
    function handleTouchMove(e){
      e.preventDefault();
      var touch = e.touches[0];
      var mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      drawingCanvas.dispatchEvent(mouseEvent);
    }
    
    // å„²å­˜æ‰‹å¯«å…§å®¹
    function saveDrawing(){
      if (!drawingCanvas) return;
      
      var notes = loadMyNotes();
      var note = notes.find(function(n){ return n.id === currentEditingNoteId; });
      if (!note) return;
      
      // å°‡ Canvas è½‰æ›ç‚º Base64 åœ–ç‰‡
      note.drawing = drawingCanvas.toDataURL('image/png');
      note.modified = new Date().toISOString();
      
      saveMyNotes(notes);
      
      // æ›´æ–°é è¦½
      var preview = document.getElementById('drawingPreview');
      preview.innerHTML = '<div style="padding:.5rem; background:white; border:1px solid var(--border); border-radius:.5rem; margin-top:.5rem"><div style="color:var(--muted); font-size:.875rem; margin-bottom:.5rem">âœ… æ‰‹å¯«å…§å®¹å·²å„²å­˜</div><img src="' + note.drawing + '" style="max-width:100%; height:auto; border-radius:.25rem" /></div>';
      
      alert('æ‰‹å¯«å…§å®¹å·²å„²å­˜ï¼');
    }
    
    // Init
    renderCalendar();
    var now = new Date();
    openNote(isoFromDate(now));
  })();
  </script>
</body>
</html>